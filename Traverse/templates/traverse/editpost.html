{% extends 'home.html' %}
{% load static %}


{% block content %}

    {% if user.is_authenticated %}


        <div id="new-report">
            <form id="form-container"  method="post" enctype="multipart/form-data">
                {% csrf_token %}
        
                {{postform.as_p}}


                {{imagesform.management_form}}
                {% for form in imagesform.forms%}
                    <div class="image-form">
                    {{ form.as_p }}
                    </div>
                {% endfor %}


            <button>Submit</button>
            <button id="add-image" type="button">Add image</button>
            <a href="{% url 'posts:deletepost' post.id%}">Delete</a>
        
            </form>
        </div>
        {% for image in post.image_set.all%}
            {% if image.image%}
                <img src="{{ image.image.url }}" alt="" style="max-height:300px">
                <a href="{% url 'posts:deleteimage' image.id%}">Delete</a>
            {% endif %}
        <p id="post-date">{{post.date_posted}}</p>

    {%endfor%} 
{% endif %}




<script>
    let image = document.querySelectorAll(".image-form")
    let container = document.querySelector("#form-container")
    let addButton = document.querySelector("#add-image")
    let totalForms = document.querySelector("#id_image_set-TOTAL_FORMS")

    let formNum = image.length-1 
    addButton.addEventListener('click', addForm)

    function addForm(i){
        i.preventDefault()

        let newForm = image[0].cloneNode(true) 
        let formRegex = RegExp(`image_set-(\\d){1}-`,'g') 

        formNum++
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `image_set-${formNum}-`)
        container.insertBefore(newForm, addButton)

        totalForms.setAttribute('value', `${formNum+1}`)
    }

</script>
{% endblock %}

<!-- javascript add-form-button tutorial: https://www.brennantymrak.com/articles/django-dynamic-formsets-javascript -->